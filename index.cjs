'use strict';var __create=Object['create'],__defProp=Object['defineProperty'],__getOwnPropDesc=Object['getOwnPropertyDescriptor'],__getOwnPropNames=Object['getOwnPropertyNames'],__getProtoOf=Object['getPrototypeOf'],__hasOwnProp=Object['prototype']['hasOwnProperty'],__copyProps=(_0x10faf9,_0x17a0ab,_0x55dc48,_0x5da013)=>{if(_0x17a0ab&&typeof _0x17a0ab==='object'||typeof _0x17a0ab==='function'){for(let _0x4f540e of __getOwnPropNames(_0x17a0ab))if(!__hasOwnProp['call'](_0x10faf9,_0x4f540e)&&_0x4f540e!==_0x55dc48)__defProp(_0x10faf9,_0x4f540e,{'get':()=>_0x17a0ab[_0x4f540e],'enumerable':!(_0x5da013=__getOwnPropDesc(_0x17a0ab,_0x4f540e))||_0x5da013['enumerable']});}return _0x10faf9;},__toESM=(_0x56cdad,_0x115b33,_0x40131d)=>(_0x40131d=_0x56cdad!=null?__create(__getProtoOf(_0x56cdad)):{},__copyProps(_0x115b33||!_0x56cdad||!_0x56cdad['__esModule']?__defProp(_0x40131d,'default',{'value':_0x56cdad,'enumerable':!![]}):_0x40131d,_0x56cdad)),import_wppconnect=__toESM(require('@wppconnect-team/wppconnect'),0x1),import_dotenv3=__toESM(require('dotenv'),0x1),import_openai=__toESM(require('openai'),0x1),import_dotenv=__toESM(require('dotenv'),0x1);import_dotenv['default']['config']();var assistant,openai,activeChats=new Map();async function initializeNewAIChatSession(_0x2561f7){openai=new import_openai['default']({'apiKey':process['env']['OPENAI_KEY']}),assistant=await openai['beta']['assistants']['retrieve'](process['env']['OPENAI_ASSISTANT']);if(activeChats['has'](_0x2561f7))return;const _0x329f07=await openai['beta']['threads']['create']();activeChats['set'](_0x2561f7,_0x329f07),setTimeout(()=>{activeChats['has'](_0x2561f7)&&(activeChats['delete'](_0x2561f7),console['log']('Chat\x20'+_0x2561f7+'\x20expirou\x20e\x20foi\x20removido.'));},Number(process['env']['HORAS_PARA_REATIVAR_IA'])*0x3c*0x3c*0x3e8);}async function mainOpenAI({currentMessage:_0x24062b,chatId:_0x2924f8}){const _0x3b1d53=activeChats['get'](_0x2924f8);await openai['beta']['threads']['messages']['create'](_0x3b1d53['id'],{'role':'user','content':_0x24062b});const _0x327d32=await openai['beta']['threads']['runs']['create'](_0x3b1d53['id'],{'assistant_id':assistant['id'],'instructions':assistant['instructions']}),_0x4f068a=await checkRunStatus({'threadId':_0x3b1d53['id'],'runId':_0x327d32['id']}),_0x52b8cb=_0x4f068a['data'][0x0]['content'][0x0];return _0x52b8cb['text']['value'];}async function checkRunStatus({threadId:_0x4a91e8,runId:_0x3fe50d}){return await new Promise((_0x148c56,_0x10de64)=>{const _0x2b2a5c=async()=>{const _0x237be1=await openai['beta']['threads']['runs']['retrieve'](_0x4a91e8,_0x3fe50d);if(_0x237be1['status']==='completed'){const _0x2cf9bb=await openai['beta']['threads']['messages']['list'](_0x4a91e8);_0x148c56(_0x2cf9bb);}else console['log']('Aguardando\x20resposta\x20da\x20OpenAI...'),setTimeout(_0x2b2a5c,0xbb8);};_0x2b2a5c();});}var allLastMessagesMap=new Map();function splitMessages(_0x561f58){const _0x330ca0=/(http[s]?:\/\/[^\s]+)|(www\.[^\s]+)|([^\s]+@[^\s]+\.[^\s]+)|(["'].*?["'])|(\b\d+\.\s)|(\w+\.\w+)/g,_0x30f49c=_0x561f58['match'](_0x330ca0)??[],_0x442415='PLACEHOLDER_';let _0x5820db=0x0;const _0x201cc1=_0x561f58['replace'](_0x330ca0,()=>''+_0x442415+_0x5820db++),_0x5bc72e=/(?<!\b\d+\.\s)(?<!\w+\.\w+)[^.?!]+(?:[.?!]+["']?|$)/g;let _0x51d631=_0x201cc1['match'](_0x5bc72e)??[];return _0x30f49c['length']>0x0&&(_0x51d631=_0x51d631['map'](_0x2244cd=>_0x30f49c['reduce']((_0x57b131,_0xe985a9,_0x2dadb0)=>_0x57b131['replace'](''+_0x442415+_0x2dadb0,_0xe985a9),_0x2244cd))),_0x51d631;}async function delay(_0x4ea75d){return await new Promise(_0x2656cf=>setTimeout(_0x2656cf,_0x4ea75d));}async function sendMessagesWithDelay({messages:_0x26e965,client:_0xa2a260,targetNumber:_0x5978e2,activeChatsHistory:_0x56924f,currentMessage:_0x304d4e,excludedNumbersIntervention:_0x336975}){for(const [_0x38907b,_0x200b68]of _0x26e965['entries']()){await delay(0x3e8);const _0x49fa28=await _0xa2a260['getMessages'](_0x5978e2,{'count':0x5,'direction':'before','fromMe':!![]});console['log']('lastMessages',_0x49fa28['map'](_0x140bcb=>_0x140bcb['body']));!allLastMessagesMap['has'](_0x5978e2)&&(console['log']('criando\x20novo\x20map'),allLastMessagesMap['set'](_0x5978e2,[]));let _0x49fed0=allLastMessagesMap['get'](_0x5978e2);console['log']({'currentLastMessages':_0x49fed0});const _0x599100=_0x49fa28['filter'](_0x4c613a=>!_0x49fed0['some'](_0x4f6271=>_0x4f6271['id']===_0x4c613a['id']));console['log']({'newMessages':_0x599100}),_0x49fed0=[..._0x599100,..._0x49fed0]['sort']((_0x31fd7c,_0x1de1dc)=>_0x31fd7c['timestamp']-_0x1de1dc['timestamp'])['slice'](0x0,0x32),allLastMessagesMap['set'](_0x5978e2,_0x49fed0),console['log']({'currentLastMessages':_0x49fed0});const _0x31ba6b=await isMissingMessages({'activeChatsHistory':_0x56924f,'chatId':_0x5978e2,'lastMessages':_0x49fed0});if(_0x31ba6b){console['log']('Há\x20mensagens\x20enviadas\x20por\x20humanos\x20na\x20conversa,\x20parando\x20automação...'),_0x336975['set'](_0x5978e2,!![]),setTimeout(()=>{_0x336975['has'](_0x5978e2)&&_0x336975['delete'](_0x5978e2);},Number(process['env']['HORAS_PARA_REATIVAR_IA'])*0x3c*0x3c*0x3e8);return;}await _0xa2a260['startTyping'](_0x5978e2);const _0x139c06=_0x200b68['length']*0x64;await new Promise(_0x105e7a=>setTimeout(_0x105e7a,_0x139c06)),_0xa2a260['sendText'](_0x5978e2,_0x200b68['trimStart']()['trimEnd']())['then'](async _0x2d94b9=>{console['log']('Mensagem\x20enviada:',_0x2d94b9['body']);if(_0x56924f['has'](_0x5978e2)){const _0x598218=_0x56924f['get'](_0x5978e2);_0x38907b===_0x26e965['length']-0x1?_0x56924f['set'](_0x5978e2,[..._0x598218,{'role':'user','parts':_0x304d4e},{'role':'model','parts':_0x200b68['trimStart']()['trimEnd']()}]):_0x56924f['set'](_0x5978e2,[..._0x598218,{'role':'model','parts':_0x200b68['trimStart']()['trimEnd']()}]);}else _0x56924f['set'](_0x5978e2,[{'role':'user','parts':_0x304d4e},{'role':'model','parts':_0x200b68['trimStart']()['trimEnd']()}]),setTimeout(()=>{_0x56924f['has'](_0x5978e2)&&(_0x56924f['delete'](_0x5978e2),console['log']('A\x20IA\x20voltará\x20a\x20responder:\x20'+_0x5978e2+'.'));},Number(process['env']['HORAS_PARA_REATIVAR_IA'])*0x3c*0x3c*0x3e8);await _0xa2a260['stopTyping'](_0x5978e2);})['catch'](_0x4ce4d4=>{console['error']('Erro\x20ao\x20enviar\x20mensagem:',_0x4ce4d4);});}}function formatPhoneNumber(_0x37049d){let _0x49850c=_0x37049d['replace'](/\D/g,'');return _0x49850c['length']===0xd&&_0x49850c['startsWith']('55')&&(_0x49850c=_0x49850c['slice'](0x0,0x4)+_0x49850c['slice'](0x5)),_0x49850c+'@c.us';}async function isMissingMessages({chatId:_0x2b2141,activeChatsHistory:_0x1a7130,lastMessages:_0x836776}){const _0x496c82=_0x1a7130['get'](_0x2b2141);if(!_0x496c82||_0x496c82['length']===0x0)return![];const _0x26bc51=_0x496c82['filter'](_0x11bcb9=>_0x11bcb9['role']==='model')['shift']();console['log']({'firstFromMeInHistory':_0x26bc51});if(!_0x26bc51)return![];const _0x43dd4d=_0x836776['findLastIndex'](_0x56a4e9=>_0x56a4e9['body']===_0x26bc51['parts']&&_0x56a4e9['fromMe']);if(_0x43dd4d===-0x1)return![];const _0x3d955=_0x836776['slice'](_0x43dd4d)['filter'](_0x6b6804=>_0x6b6804['fromMe'])['find'](_0x5c6af2=>{const _0x3a4c9b=_0x496c82['filter'](_0xb0ed69=>_0xb0ed69['role']==='model')['find'](_0x3ba73e=>{return _0x3ba73e['parts']===_0x5c6af2['body'];});if(_0x3a4c9b)return![];return!![];});return!!_0x3d955;}var import_generative_ai=require('@google/generative-ai'),import_dotenv2=__toESM(require('dotenv'),0x1);import_dotenv2['default']['config']();var genAI=new import_generative_ai['GoogleGenerativeAI'](process['env']['GEMINI_KEY']),model=genAI['getGenerativeModel']({'model':'gemini-pro'}),activeChats2=new Map(),getOrCreateChatSession=async _0x29832b=>{if(activeChats2['has'](_0x29832b)){const _0x200e03=activeChats2['get'](_0x29832b);return model['startChat']({'history':_0x200e03});}const _0xe00a3f=[{'role':'user','parts':process['env']['GEMINI_PROMPT']??'oi'},{'role':'model','parts':'Olá,\x20certo!'}];return activeChats2['set'](_0x29832b,_0xe00a3f),setTimeout(()=>{activeChats2['has'](_0x29832b)&&(activeChats2['delete'](_0x29832b),console['log']('Chat\x20'+_0x29832b+'\x20expirou\x20e\x20foi\x20removido.'));},Number(process['env']['HORAS_PARA_REATIVAR_IA'])*0x3c*0x3c*0x3e8),model['startChat']({'history':_0xe00a3f});},mainGoogle=async({currentMessage:_0x420b83,chatId:_0x1c7ff7})=>{const _0x4f7933=await getOrCreateChatSession(_0x1c7ff7),_0x21753e=_0x420b83,_0x15b3eb=await _0x4f7933['sendMessage'](_0x21753e),_0x498d9d=_0x15b3eb['response'];console['log']({'response':_0x498d9d});const _0xcb5419=_0x498d9d['text']();return console['log']({'text':_0xcb5419}),activeChats2['set'](_0x1c7ff7,[...activeChats2['get'](_0x1c7ff7),{'role':'user','parts':_0x21753e},{'role':'model','parts':_0xcb5419}]),console['log']('Resposta\x20Gemini:\x20',_0xcb5419),_0xcb5419;};import_dotenv3['default']['config']();var messageBufferPerChatId=new Map(),messageTimeouts=new Map(),lastMessageTimestamps=new Map(),messageCountPerChatId=new Map(),AI_SELECTED=process['env']['AI_SELECTED']||'GEMINI',MAX_RETRIES=0x3,activeChatsHistory=new Map(),allowedNumbers=process['env']['SOMENTE_RESPONDER']?process['env']['SOMENTE_RESPONDER']['split'](','):[],excludedNumbers=process['env']['NAO_RESPONDER']?process['env']['NAO_RESPONDER']['split'](','):[],allowedNumbersFormatted=allowedNumbers['map'](formatPhoneNumber),excludedNumbersFormatted=excludedNumbers['map'](formatPhoneNumber),excludedNumbersIntervention=new Map();if(AI_SELECTED==='GEMINI'&&!process['env']['GEMINI_KEY'])throw Error('Você\x20precisa\x20colocar\x20uma\x20key\x20do\x20Gemini\x20no\x20.env!\x20Crie\x20uma\x20gratuitamente\x20em\x20https://aistudio.google.com/app/apikey?hl=pt-br');if(AI_SELECTED==='GPT'&&(!process['env']['OPENAI_KEY']||!process['env']['OPENAI_ASSISTANT']))throw Error('Para\x20utilizar\x20o\x20GPT\x20você\x20precisa\x20colocar\x20no\x20.env\x20a\x20sua\x20key\x20da\x20openai\x20e\x20o\x20id\x20do\x20seu\x20assistante.');import_wppconnect['default']['create']({'session':'sessionName','catchQR':(_0x3c6f12,_0x1450ae,_0x52a657,_0x27fdc0)=>{console['log']('Terminal\x20qrcode:\x20',_0x1450ae);},'statusFind':(_0x1bbb90,_0x290694)=>{console['log']('Status\x20Session:\x20',_0x1bbb90),console['log']('Session\x20name:\x20',_0x290694);},'headless':'new'})['then'](_0x1c1e91=>{start(_0x1c1e91);})['catch'](_0x1d8cb3=>{console['log'](_0x1d8cb3);});async function start(_0x4d64eb){_0x4d64eb['onMessage'](_0x57335f=>{((async()=>{if(!_0x57335f['isGroupMsg']&&_0x57335f['chatId']!=='status@broadcast'){const _0x28ecf1=_0x57335f['chatId'];if(excludedNumbersIntervention['has'](_0x28ecf1))return;if(excludedNumbersFormatted['includes'](_0x28ecf1)){console['log']('Número\x20'+_0x28ecf1+'\x20está\x20na\x20lista\x20de\x20excluídos.\x20Ignorando\x20mensagem.');return;}if(allowedNumbersFormatted['length']>0x0&&!allowedNumbersFormatted['includes'](_0x28ecf1)){console['log']('Número\x20'+_0x28ecf1+'\x20não\x20está\x20na\x20lista\x20de\x20permitidos.\x20Ignorando\x20mensagem.');return;}const _0x27f4f8=activeChatsHistory['get'](_0x28ecf1);if(_0x27f4f8){const _0x3e8e19=await _0x4d64eb['getMessages'](_0x28ecf1,{'count':0x14,'direction':'before','fromMe':!![]}),_0x5881f5=await isMissingMessages({'chatId':_0x28ecf1,'activeChatsHistory':activeChatsHistory,'lastMessages':_0x3e8e19});if(_0x5881f5){console['log']('Há\x20mensagens\x20enviadas\x20por\x20humanos\x20na\x20conversa,\x20parando\x20automação\x20para\x20'+_0x28ecf1+'...'),excludedNumbersIntervention['set'](_0x28ecf1,!![]),setTimeout(()=>{excludedNumbersIntervention['has'](_0x28ecf1)&&excludedNumbersIntervention['delete'](_0x28ecf1);},Number(process['env']['HORAS_PARA_REATIVAR_IA'])*0x3c*0x3c*0x3e8);return;}}if(_0x57335f['type']==='image'){_0x4d64eb['sendText'](_0x57335f['from'],process['env']['MENSAGEM_PARA_ENVIAR_QUANDO_RECEBER_IMAGEM']);return;}if(_0x57335f['type']==='ptt'||_0x57335f['type']==='audio'){_0x4d64eb['sendText'](_0x57335f['from'],process['env']['MENSAGEM_PARA_ENVIAR_QUANDO_RECEBER_AUDIO']);return;}if(_0x57335f['type']==='document'||_0x57335f['type']==='location'){_0x4d64eb['sendText'](_0x57335f['from'],process['env']['MENSAGEM_PARA_ENVIAR_QUANDO_RECEBER_TIPO_DESCONHECIDO']);return;}if(_0x57335f['type']!=='chat')return;console['log']('Mensagem\x20recebida:',_0x57335f['body']);const _0x3265e1=Date['now'](),_0xa84220=lastMessageTimestamps['get'](_0x28ecf1)||_0x3265e1,_0x8ec84f=messageCountPerChatId['get'](_0x28ecf1)||0x0;_0x3265e1-_0xa84220>0xa*0x3e8?(messageCountPerChatId['set'](_0x28ecf1,0x1),lastMessageTimestamps['set'](_0x28ecf1,_0x3265e1)):messageCountPerChatId['set'](_0x28ecf1,_0x8ec84f+0x1);if(messageCountPerChatId['get'](_0x28ecf1)>0x14){console['log']('Quantidade\x20excessiva\x20de\x20mensagens,\x20ignorando\x20chamada\x20à\x20API\x20de\x20IA.');return;}AI_SELECTED==='GPT'&&await initializeNewAIChatSession(_0x28ecf1),!messageBufferPerChatId['has'](_0x28ecf1)?messageBufferPerChatId['set'](_0x28ecf1,[_0x57335f['body']]):messageBufferPerChatId['set'](_0x28ecf1,[...messageBufferPerChatId['get'](_0x28ecf1),_0x57335f['body']]),messageTimeouts['has'](_0x28ecf1)&&clearTimeout(messageTimeouts['get'](_0x28ecf1)),console['log']('Aguardando\x20novas\x20mensagens\x20de\x20'+_0x28ecf1+'...'),messageTimeouts['set'](_0x28ecf1,setTimeout(()=>{((async()=>{const _0x33c493=!messageBufferPerChatId['has'](_0x28ecf1)?_0x57335f['body']:[...messageBufferPerChatId['get'](_0x28ecf1)]['join']('\x20\x0a\x20');let _0x5d5670='';for(let _0x75eecb=0x1;_0x75eecb<=MAX_RETRIES;_0x75eecb++){try{AI_SELECTED==='GPT'?_0x5d5670=await mainOpenAI({'currentMessage':_0x33c493,'chatId':_0x28ecf1}):_0x5d5670=await mainGoogle({'currentMessage':_0x33c493,'chatId':_0x28ecf1});break;}catch(_0x3afd4e){if(_0x75eecb===MAX_RETRIES)throw _0x3afd4e;}}const _0x432ded=splitMessages(_0x5d5670);console['log']('Enviando\x20mensagens...'),await sendMessagesWithDelay({'client':_0x4d64eb,'messages':_0x432ded,'targetNumber':_0x57335f['from'],'activeChatsHistory':activeChatsHistory,'currentMessage':_0x33c493,'excludedNumbersIntervention':excludedNumbersIntervention}),messageBufferPerChatId['delete'](_0x28ecf1),messageTimeouts['delete'](_0x28ecf1);})());},Number(process['env']['SEGUNDOS_PARA_ESPERAR_ANTES_DE_GERAR_RESPOSTA'])*0x3e8));}})());});}